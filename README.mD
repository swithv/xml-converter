# ğŸ“Š Sistema de ConversÃ£o e Dashboard de NF-e v2.0

## ğŸ¯ VersÃ£o Final - 100% Conforme Leiaute Oficial

**ReferÃªncia**: [Leiaute Oficial da NF-e](http://moc.sped.fazenda.pr.gov.br/Leiaute.html)  
**Nota TÃ©cnica**: NT 2025.001 v.1.02

---

## ğŸ“‹ CaracterÃ­sticas Principais

### âœ… Conformidade Total com o Leiaute
- **Namespace correto**: `http://www.portalfiscal.inf.br/nfe`
- **Mapeamento por IDs oficiais**: Todos os campos mapeados conforme IDs do manual (A01, B01, C01, etc.)
- **Granularidade por item**: Sistema gera **UMA LINHA POR ITEM** (tag `<det>` - ID H01)
- **ExtraÃ§Ã£o genÃ©rica de impostos**: Funciona com TODOS os CST de ICMS (00, 10, 20, 30, 40, 51, 60, 70, 90, etc.)

### ğŸ”§ Grupos Implementados

| Grupo | DescriÃ§Ã£o | IDs | Status |
|-------|-----------|-----|--------|
| **A** | InformaÃ§Ãµes da NF-e | A01-A04 | âœ… |
| **B** | IdentificaÃ§Ã£o | B01-B29 | âœ… |
| **C** | Emitente | C01-C19 | âœ… |
| **E** | DestinatÃ¡rio | E01-E19 | âœ… |
| **H** | Detalhamento (det) | H01-H02 | âœ… |
| **I** | Produtos e ServiÃ§os | I01-I80 | âœ… |
| **M** | Tributos | M01-M02 | âœ… |
| **N** | ICMS | N01-N37 | âœ… |
| **NA** | ICMSUFDest (DIFAL) | NA01-NA19 | âœ… |
| **O** | IPI | O01-O17 | âœ… |
| **Q** | PIS | Q01-Q10 | âœ… |
| **S** | COFINS | S01-S10 | âœ… |
| **W** | Total da NF-e | W01-W29 | âœ… |

---

## ğŸš€ InstalaÃ§Ã£o e Uso

### 1. Requisitos
```bash
pip install -r requirements.txt
```

**Arquivo `requirements.txt`**:
```
streamlit==1.28.0
lxml==5.3.0
pandas>=2.2.0
openpyxl==3.1.2
plotly==5.17.0
```

### 2. Estrutura de Arquivos
```
projeto/
â”œâ”€â”€ app.py                 # Interface Streamlit
â”œâ”€â”€ nfe_parser.py          # Motor de extraÃ§Ã£o
â”œâ”€â”€ dashboard_logic.py     # LÃ³gica dos grÃ¡ficos
â”œâ”€â”€ requirements.txt       # DependÃªncias
â”œâ”€â”€ logo.png              # Logo (opcional)
â””â”€â”€ README.md             # Esta documentaÃ§Ã£o
```

### 3. Executar
```bash
streamlit run app.py
```

---

## ğŸ“¦ Campos DisponÃ­veis

### Grupo B - IdentificaÃ§Ã£o da NF-e
- **ID A03**: Chave de Acesso (44 dÃ­gitos)
- **ID B08**: NÃºmero da NF
- **ID B07**: SÃ©rie
- **ID B09**: Data e Hora de EmissÃ£o
- **ID B05**: Natureza da OperaÃ§Ã£o
- **ID B06**: Modelo (55 ou 65)
- **ID A02**: VersÃ£o (4.00)

### Grupo C - Emitente
- **ID C02/C02a**: CNPJ ou CPF do Emitente
- **ID C03**: RazÃ£o Social
- **ID C04**: Nome Fantasia

### Grupo E - DestinatÃ¡rio
- **ID E02/E03**: CNPJ ou CPF do DestinatÃ¡rio
- **ID E04**: RazÃ£o Social
- **ID E17**: InscriÃ§Ã£o Estadual

### Grupo I - Produtos (NÃ­vel do Item)
- **ID H02**: NÃºmero do Item (atributo nItem)
- **ID I02**: CÃ³digo do Produto (cProd)
- **ID I03**: CÃ³digo EAN/GTIN
- **ID I04**: DescriÃ§Ã£o do Produto (xProd)
- **ID I05**: NCM (8 dÃ­gitos)
- **ID I08**: CEST
- **ID I09**: CFOP
- **ID I10**: Unidade Comercial (uCom)
- **ID I11**: Quantidade Comercial (qCom)
- **ID I12**: Valor UnitÃ¡rio (vUnCom)
- **ID I13**: Valor Total do Item (vProd)

### Grupo N - ICMS (Todos os CST)
- **ID N11**: Origem da Mercadoria (0-8)
- **ID N12**: CST ICMS
- **ID N13**: Modalidade BC ICMS
- **ID N15**: Base de CÃ¡lculo ICMS (vBC)
- **ID N16**: AlÃ­quota ICMS % (pICMS)
- **ID N17**: Valor ICMS (vICMS)

### Grupo NA - ICMSUFDest (DIFAL)
- **ID NA03**: BC ICMS UF Destino (vBCUFDest)
- **ID NA04**: BC FCP UF Destino (vBCFCPUFDest)
- **ID NA05**: Percentual FCP UF Destino % (pFCPUFDest)
- **ID NA07**: AlÃ­quota Interna UF Destino % (pICMSUFDest)
- **ID NA09**: AlÃ­quota Interestadual % (pICMSInter)
- **ID NA11**: Percentual Partilha ICMS % (pICMSInterPart) âš ï¸ **CRÃTICO**
- **ID NA13**: Valor FCP UF Destino (vFCPUFDest)
- **ID NA15**: Valor ICMS UF Destino (vICMSUFDest)
- **ID NA17**: Valor ICMS UF Remetente (vICMSUFRemet)

### Outros Impostos
- **Grupo O**: Valor IPI (vIPI)
- **Grupo Q**: Valor PIS (vPIS)
- **Grupo S**: Valor COFINS (vCOFINS)

### Grupo W - Totais
- **ID W29**: Valor Total da NF-e (vNF)
- **ID W12**: Valor Total dos Produtos (vProd)
- **ID W14**: Valor Total do ICMS (vICMS)
- **ID W16**: Valor Total do IPI (vIPI)

---

## ğŸ” Detalhes TÃ©cnicos

### ExtraÃ§Ã£o de ICMS (Grupo N)

O sistema utiliza **busca genÃ©rica** para capturar valores de ICMS independentemente do CST:

```python
# XPath genÃ©rico que funciona com TODOS os CST
xpath = './/nfe:imposto/nfe:ICMS//nfe:vICMS'
```

**Suporta todos os grupos**:
- ICMS00 (ID N02) - Tributada integralmente
- ICMS10 (ID N03) - Tributada com ST
- ICMS20 (ID N04) - Com reduÃ§Ã£o de BC
- ICMS30 (ID N05) - Isenta com ST
- ICMS40/41/50 (ID N06) - Isenta/NÃ£o tributada/SuspensÃ£o
- ICMS51 (ID N07) - Diferimento
- ICMS60 (ID N08) - ICMS ST retido anteriormente
- ICMS70 (ID N09) - Com reduÃ§Ã£o e ST
- ICMS90 (ID N10) - Outros
- ICMSSN101, 102, 201, 202, 500, 900 - Simples Nacional

### ExtraÃ§Ã£o de DIFAL (Grupo NA)

O grupo **ICMSUFDest** Ã© extraÃ­do diretamente:

```python
xpath = './/nfe:imposto/nfe:ICMSUFDest/nfe:pICMSInterPart'
```

**Importante**: Este grupo sÃ³ existe em:
- OperaÃ§Ãµes interestaduais
- Destinadas a consumidor final nÃ£o contribuinte
- A partir de 2016 (NF-e 4.00)

### ConversÃ£o de Tipos

Todos os campos numÃ©ricos sÃ£o convertidos para `float`:

```python
numeric_fields = [
    'Quantidade Comercial',
    'Valor UnitÃ¡rio',
    'Valor Total Item',
    'Base CÃ¡lculo ICMS',
    'AlÃ­quota ICMS',
    'Valor ICMS',
    # ... todos os valores monetÃ¡rios e percentuais
]

for field in numeric_fields:
    df[field] = pd.to_numeric(df[field], errors='coerce').fillna(0.0)
```

**Valores ausentes** = `0.0` (nunca `None` ou `NaN`)

---

## âš ï¸ Avisos Importantes

### 1. Granularidade Alterada

**ANTES** (v1.0):
- 1 NF-e = 1 linha no resultado
- Dados consolidados por nota

**AGORA** (v2.0):
- 1 NF-e com 5 itens = 5 linhas no resultado
- Dados detalhados por produto

### 2. Impacto em Processos Existentes

Se vocÃª tinha rotinas que dependiam de "1 linha = 1 NF-e", serÃ¡ necessÃ¡rio:

**No Excel**:
```excel
=SUMIF(A:A, "ChaveAcesso", D:D)  # Agregar por NF-e
=UNIQUE(A:A)                      # Listar NF-e Ãºnicas
```

**No Python/Pandas**:
```python
# Agregar por NF-e
df_nfe = df.drop_duplicates(subset='Chave de Acesso')
total_por_nfe = df.groupby('Chave de Acesso')['Valor Total Item'].sum()
```

### 3. Campo CrÃ­tico: Percentual Partilha ICMS (ID NA11)

O campo **pICMSInterPart** Ã© **OBRIGATÃ“RIO** quando hÃ¡ DIFAL.

**Valores vÃ¡lidos em 2025**:
- OperaÃ§Ãµes em 2024-2025: `100.0` (100% para UF de destino)

**RejeiÃ§Ã£o 699**: Ocorre quando este campo estÃ¡ ausente ou incorreto em operaÃ§Ãµes com DIFAL.

---

## ğŸ“Š Exemplos de Uso

### Caso 1: Controle de Estoque

**Objetivo**: Extrair produtos vendidos com quantidades.

**Campos necessÃ¡rios**:
- Chave de Acesso
- Data e Hora de EmissÃ£o
- CÃ³d. Produto
- DescriÃ§Ã£o do Produto
- Quantidade Comercial
- Unidade Comercial

**Resultado**:
```
Chave          | Data       | CÃ³d.  | Produto   | Qtd | Un
35240...       | 2024-01-15 | 001   | NOTEBOOK  | 2.0 | UN
35240...       | 2024-01-15 | 002   | MOUSE     | 5.0 | UN
```

### Caso 2: AnÃ¡lise TributÃ¡ria

**Objetivo**: Calcular carga tributÃ¡ria por produto.

**Campos necessÃ¡rios**:
- NÃºmero da NF
- CÃ³d. Produto
- DescriÃ§Ã£o do Produto
- Valor Total Item
- Base CÃ¡lculo ICMS
- AlÃ­quota ICMS
- Valor ICMS
- Valor IPI
- Valor PIS
- Valor COFINS

**AnÃ¡lise**:
```python
# Carga tributÃ¡ria total
df['Impostos'] = df['Valor ICMS'] + df['Valor IPI'] + df['Valor PIS'] + df['Valor COFINS']
df['Carga %'] = (df['Impostos'] / df['Valor Total Item'] * 100).round(2)
```

### Caso 3: Auditoria DIFAL

**Objetivo**: Validar cÃ¡lculo de DIFAL em operaÃ§Ãµes interestaduais.

**Campos necessÃ¡rios**:
- Chave de Acesso
- NÃºmero da NF
- CÃ³d. Produto
- DescriÃ§Ã£o do Produto
- Valor Total Item
- BC ICMS UF Destino
- AlÃ­quota Interna UF Destino
- AlÃ­quota Interestadual
- **Percentual Partilha ICMS** âš ï¸
- Valor ICMS UF Destino
- Valor ICMS UF Remetente

**ValidaÃ§Ãµes**:
```python
# 1. Percentual Partilha deve ser 100% em 2024-2025
assert df['Percentual Partilha ICMS'].unique() == [100.0]

# 2. ICMS Dest + ICMS Rem = DIFAL total
df['DIFAL Total'] = df['Valor ICMS UF Destino'] + df['Valor ICMS UF Remetente']
```

---

## ğŸ› Troubleshooting

### Problema 1: "Nenhum dado foi extraÃ­do"

**Causas**:
- Nenhum campo selecionado
- XML corrompido
- Namespace incorreto (muito raro)

**SoluÃ§Ã£o**:
1. Marque ao menos os campos essenciais (marcados por padrÃ£o)
2. Valide XML em ferramenta externa
3. Verifique se o arquivo Ã© NF-e (modelo 55) ou NFC-e (modelo 65)

### Problema 2: Valores aparecem como texto no Excel

**Causa**: Separador decimal incorreto no sistema.

**SoluÃ§Ã£o**:
- Use download **XLSX** (nÃ£o CSV)
- Configure Excel: Arquivo â†’ OpÃ§Ãµes â†’ AvanÃ§ado â†’ Separador decimal = "."

### Problema 3: DIFAL nÃ£o aparece

**Causa**: A NF-e nÃ£o possui operaÃ§Ã£o interestadual para consumidor final.

**VerificaÃ§Ã£o**:
```python
# Contar NF-e com DIFAL
nfe_com_difal = df[df['Valor ICMS UF Destino'] > 0]['Chave de Acesso'].nunique()
print(f"{nfe_com_difal} NF-e(s) com DIFAL")
```

### Problema 4: Dashboard nÃ£o funciona

**Causa**: Campos necessÃ¡rios nÃ£o foram selecionados.

**SoluÃ§Ã£o**: Marque estes campos mÃ­nimos:
- Chave de Acesso ou NÃºmero da NF
- Data e Hora de EmissÃ£o
- Valor Total da NF
- DescriÃ§Ã£o do Produto
- Quantidade Comercial

---

## ğŸ“ Suporte

**TRR Contabilidade**

- ğŸŒ Website: [trrcontabil.com](https://trrcontabil.com)
- ğŸ“· Instagram: [@trr_contabilidade](https://www.instagram.com/trr_contabilidade/)
- ğŸ“ WhatsApp: [(91) 99241-2788](https://wa.me/5591992412788)

---

## ğŸ“ Changelog

### v2.0.0 (VersÃ£o Final) - 16/10/2025

**Novo**:
- âœ… Conformidade total com leiaute oficial NT 2025.001
- âœ… Mapeamento por IDs oficiais (A01, B01, C01, etc.)
- âœ… Granularidade alterada para nÃ­vel de item (det - ID H01)
- âœ… Novos campos: CÃ³digo EAN, Unidade Comercial, Nome Fantasia
- âœ… Grupo ICMSUFDest (DIFAL) completo - IDs NA01-NA19
- âœ… ExtraÃ§Ã£o genÃ©rica de ICMS (todos os CST)
- âœ… ExtraÃ§Ã£o de IPI, PIS, COFINS
- âœ… ConversÃ£o automÃ¡tica de tipos numÃ©ricos
- âœ… Valores padrÃ£o: 0.0 para campos numÃ©ricos ausentes
- âœ… Interface com IDs do leiaute nos labels
- âœ… Tratamento robusto de erros

**Corrigido**:
- âœ… Namespace garantido em todas as buscas
- âœ… XPath genÃ©rico para impostos
- âœ… ExtraÃ§Ã£o de FCP (Fundo de Combate Ã  Pobreza)

### v1.0.0 - VersÃ£o Anterior
- Granularidade por NF-e
- Campos bÃ¡sicos de produto
- DIFAL parcialmente implementado

---

## ğŸ“š ReferÃªncias

1. **Manual Oficial**: [Leiaute da NF-e](http://moc.sped.fazenda.pr.gov.br/Leiaute.html)
2. **Portal Nacional NF-e**: [www.nfe.fazenda.gov.br](http://www.nfe.fazenda.gov.br)
3. **Nota TÃ©cnica**: NT 2025.001 v.1.02 (02/09/2025)
4. **Schema XSD**: VersÃ£o 4.00

---

## âš–ï¸ LicenÃ§a

Sistema desenvolvido por **TRR Contabilidade** para uso interno e de clientes.

---

**Ãšltima atualizaÃ§Ã£o**: 16/10/2025  
**VersÃ£o**: 2.0.0 Final  
**Desenvolvido com**: Python 3.8+ | Streamlit | lxml | pandas